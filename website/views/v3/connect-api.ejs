<!doctype html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <title>Connect API - OTP Bot</title>
  <style>
    /* Fix dropdown overflow */
    select {
      max-height: 200px !important;
      overflow-y: auto !important;
    }
    select option {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    /* Ensure dropdown doesn't overflow container */
    .bg-white {
      overflow: visible;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Include Navbar -->
  <%- include('partials/navbar', { page: 'connect-api' }) %>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Connect API</h1>
      <p class="text-gray-600">Connect your services with external API providers</p>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <form id="connectApiForm" class="space-y-6">
        <!-- Select Server -->
        <div>
          <label for="server" class="block text-sm font-medium text-gray-700 mb-2">
            Select Server <span class="text-red-500">*</span>
          </label>
          <select 
            id="server" 
            name="server" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
            style="max-height: 200px; overflow-y: auto;"
          >
            <option value="">Choose a server</option>
            <% if (servers && servers.length > 0) { %>
              <% servers.forEach(function (obj, i){ %>
                <% var isSelected = (obj._id || obj.id) == myApi?.server_id ? "selected" : "" %>
                <% var serverName = obj.server_name || obj.name || 'Server ' + (i + 1) %>
                <option value="<%= obj._id || obj.id %>" <%= isSelected %> title="<%= serverName %>"><%= serverName.length > 50 ? serverName.substring(0, 50) + '...' : serverName %></option>
              <% }) %>
            <% } else { %>
              <option value="" disabled>No servers available. Please add servers first.</option>
            <% } %>
          </select>
        </div>

        <!-- API URL -->
        <div>
          <label for="api_url" class="block text-sm font-medium text-gray-700 mb-2">
            API URL <span class="text-red-500">*</span>
          </label>
          <input 
            type="url" 
            id="api_url" 
            name="api_url" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
            placeholder="https://api.example.com"
            value="<%= myApi?.api_url %>"
          >
          <p class="mt-1 text-sm text-gray-500">Enter the base URL of your API provider</p>
        </div>

        <!-- API Key -->
        <div>
          <label for="api_key" class="block text-sm font-medium text-gray-700 mb-2">
            API Key <span class="text-red-500">*</span>
          </label>
          <input 
            type="password" 
            id="api_key" 
            name="api_key" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
            placeholder="Enter your API key"
            value="<%= myApi?.api_key %>"
          >
        </div>

        <!-- API Type -->
        <div>
          <label for="api_type" class="block text-sm font-medium text-gray-700 mb-2">
            API Type <span class="text-red-500">*</span>
          </label>
          <select 
            id="api_type" 
            name="api_type" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
          >
            <option value="">Select API type</option>
            <option value="5sim" <%= myApi?.api_type == '5sim' ? 'selected' : '' %>>5sim</option>
            <option value="sms-activate" <%= myApi?.api_type == 'sms-activate' ? 'selected' : '' %>>SMS Activate</option>
            <option value="smspool" <%= myApi?.api_type == 'smspool' ? 'selected' : '' %>>SMSPool</option>
            <option value="custom" <%= myApi?.api_type == 'custom' ? 'selected' : '' %>>Custom API</option>
          </select>
        </div>

        <!-- Status -->
        <div>
          <label class="flex items-center">
            <input 
              type="checkbox" 
              id="is_active" 
              name="is_active" 
              checked
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            >
            <span class="ml-2 text-sm text-gray-700">API connection is active</span>
          </label>
        </div>

        <!-- Submit Button -->
        <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
          <button 
            type="button" 
            onclick="window.history.back()"
            class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors font-medium"
          >
            Cancel
          </button>
          <button 
            type="submit"
            id="submit-btn"
            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center"
          >
            <i class="fas fa-plug mr-2"></i>
            Connect API
          </button>
        </div>
      </form>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="mt-6"></div>
  </div>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="text-center text-gray-600">
        <p>&copy; 2024 OTP Bot. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Form JavaScript -->
  <script>
    document.getElementById('connectApiForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const originalText = submitBtn.innerHTML;
      
      // Get form data
      const formData = new FormData(this);
      const apiData = {
        server_id: formData.get('server'),
        api_url: formData.get('api_url'),
        api_key: formData.get('api_key'),
        api_type: formData.get('api_type'),
        status: formData.get('is_active') === 'on'
      };
      
      // Debug: Log the form data
      console.log('üîç [DEBUG] Form data collected:');
      console.log('   - server_id:', apiData.server_id);
      console.log('   - api_url:', apiData.api_url);
      console.log('   - api_key:', apiData.api_key);
      console.log('   - api_type:', apiData.api_type);
      console.log('   - status:', apiData.status);
      
      // Validate required fields
      if (!apiData.server_id || !apiData.api_url || !apiData.api_key || !apiData.api_type) {
        console.log('‚ùå [DEBUG] Validation failed:');
        console.log('   - server_id missing:', !apiData.server_id);
        console.log('   - api_url missing:', !apiData.api_url);
        console.log('   - api_key missing:', !apiData.api_key);
        console.log('   - api_type missing:', !apiData.api_type);
        showMessage('Please fill in all required fields', 'error');
        return;
      }
      
      // Show loading state
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';
      submitBtn.disabled = true;
      
      try {
        // Send API request
        // Get backend URL - use environment variable or fallback to current origin
        function getBackendUrl() {
          // Check if we're on Vercel (production)
          if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            // Use the same domain for Vercel deployment
            return window.location.origin;
          } else {
            // Use localhost:3001 for local development
            return 'http://localhost:3001';
          }
        }

        const backendUrl = getBackendUrl();
        console.log(`üîó [DEBUG] Using backend URL: ${backendUrl}`);
        
        const response = await fetch(`${backendUrl}/connect-api`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(apiData)
        });
        
        const result = await response.json();
        
        if (result.status === 1) {
          showMessage(result.message || 'API connected successfully!', 'success');
          
          // Reset form
          this.reset();
          
          // Redirect to my-services page after 2 seconds
          setTimeout(() => {
            window.location.href = '/my-services';
          }, 2000);
        } else {
          showMessage(result.message || 'Failed to connect API', 'error');
        }
      } catch (error) {
        console.error('Error connecting API:', error);
        showMessage('Error connecting API. Please try again.', 'error');
      } finally {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });
    
    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      const alertClass = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
      
      container.innerHTML = `
        <div class="border rounded-lg p-4 ${alertClass}">
          <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
            <span>${message}</span>
          </div>
        </div>
      `;
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
  </script>
</body>
</html>

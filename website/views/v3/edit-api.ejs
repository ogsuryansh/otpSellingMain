<!DOCTYPE html>
<html lang="en">
<head>
  <%- include("./partials/head") %>
  <title>Edit API - OTP Bot</title>
</head>
<body class="bg-gray-50">
  <%- include("./partials/alert") %>

  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-gray-900">Edit API</h1>
        </div>
        <div class="flex items-center space-x-4">
          <a href="/my-services" class="text-blue-600 hover:text-blue-800 font-medium">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to My Services
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">API Information</h2>
        <p class="text-gray-600">Update the API connection details below</p>
      </div>

      <form id="editApiForm" class="space-y-6">
        <input type="hidden" id="apiId" value="<%= api._id %>">
        
        <!-- Server Selection -->
        <div>
          <label for="server_id" class="block text-sm font-medium text-gray-700 mb-2">
            Server <span class="text-red-500">*</span>
          </label>
          <select 
            id="server_id" 
            name="server_id" 
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            required
          >
            <option value="">Select a server</option>
            <% servers.forEach(server => { %>
              <option value="<%= server._id %>" <%= api.server_id === server._id.toString() ? 'selected' : '' %>>
                <%= server.server_name %> (<%= server.country %>)
              </option>
            <% }) %>
          </select>
        </div>

        <!-- API URL -->
        <div>
          <label for="api_url" class="block text-sm font-medium text-gray-700 mb-2">
            API URL <span class="text-red-500">*</span>
          </label>
          <input 
            type="url" 
            id="api_url" 
            name="api_url" 
            value="<%= api.api_url %>"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="https://api.example.com/endpoint"
            required
          >
        </div>

        <!-- API Key -->
        <div>
          <label for="api_key" class="block text-sm font-medium text-gray-700 mb-2">
            API Key <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="api_key" 
            name="api_key" 
            value="<%= api.api_key %>"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="Enter API key"
            required
          >
        </div>

        <!-- API Type -->
        <div>
          <label for="api_type" class="block text-sm font-medium text-gray-700 mb-2">
            API Type
          </label>
          <select 
            id="api_type" 
            name="api_type" 
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="GET" <%= api.api_type === 'GET' ? 'selected' : '' %>>GET</option>
            <option value="POST" <%= api.api_type === 'POST' ? 'selected' : '' %>>POST</option>
            <option value="PUT" <%= api.api_type === 'PUT' ? 'selected' : '' %>>PUT</option>
            <option value="DELETE" <%= api.api_type === 'DELETE' ? 'selected' : '' %>>DELETE</option>
          </select>
        </div>

        <!-- Status -->
        <div>
          <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
            Status
          </label>
          <select 
            id="status" 
            name="status" 
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="true" <%= api.status === true ? 'selected' : '' %>>Active</option>
            <option value="false" <%= api.status === false ? 'selected' : '' %>>Inactive</option>
          </select>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
            Description
          </label>
          <textarea 
            id="description" 
            name="description" 
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="Enter API description"
          ><%= api.description || '' %></textarea>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end space-x-4">
          <a 
            href="/my-services" 
            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors"
          >
            Cancel
          </a>
          <button 
            type="submit"
            id="submit-btn"
            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center"
          >
            <i class="fas fa-save mr-2"></i>
            Update API
          </button>
        </div>
      </form>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="mt-6"></div>
  </div>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="text-center text-gray-600">
        <p>&copy; 2024 OTP Bot. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Form JavaScript -->
  <script>
    document.getElementById('editApiForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const originalText = submitBtn.innerHTML;
      const apiId = document.getElementById('apiId').value;
      
      // Get form data
      const formData = new FormData(this);
      const apiData = {
        server_id: formData.get('server_id'),
        api_url: formData.get('api_url'),
        api_key: formData.get('api_key'),
        api_type: formData.get('api_type'),
        status: formData.get('status'),
        description: formData.get('description')
      };
      
      // Validate required fields
      if (!apiData.server_id || !apiData.api_url || !apiData.api_key) {
        showMessage('Required fields are missing!', 'error');
        return;
      }
      
      // Show loading state
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
      submitBtn.disabled = true;
      
      try {
        // Get backend URL
        function getBackendUrl() {
          if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            return window.location.origin;
          } else {
            return 'http://localhost:3001';
          }
        }

        const backendUrl = getBackendUrl();
        console.log(`ðŸ”— [DEBUG] Using backend URL: ${backendUrl}`);
        
        const response = await fetch(`${backendUrl}/update-api/${apiId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(apiData)
        });
        
        const result = await response.json();
        
        if (result.status === 1) {
          showMessage('API updated successfully!', 'success');
          setTimeout(() => {
            window.location.href = '/my-services';
          }, 1500);
        } else {
          showMessage(result.message || 'Error updating API', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('Error updating API. Please try again.', 'error');
      } finally {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      const alertClass = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
      
      container.innerHTML = `
        <div class="border rounded-md p-4 ${alertClass}">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium">${message}</p>
            </div>
          </div>
        </div>
      `;
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
  </script>
</body>
</html>
